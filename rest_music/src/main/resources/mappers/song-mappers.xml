<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.itwill.rest.repository.SongDao">
  
    <select id="detailBySongId" resultType="SongDetail">
        SELECT s.title AS song_title, a.album_name, a.album_image, s.genre, si.singer_name,
        LISTAGG(DISTINCT wr.writer, ', ') WITHIN GROUP (ORDER BY wr.writer) AS writers,
        LISTAGG(DISTINCT co.composer, ', ') WITHIN GROUP (ORDER BY co.composer) AS composers,
        LISTAGG(DISTINCT ar.arranger, ', ') WITHIN GROUP (ORDER BY ar.arranger) AS arrangers,
        s.lyrics
        FROM
            songs s
        JOIN
            albums a ON s.album_id = a.album_id
        LEFT JOIN
            singers si ON s.song_id = si.song_id
        LEFT JOIN
            writers wr ON s.song_id = wr.song_id
        LEFT JOIN
            composers co ON s.song_id = co.song_id
        LEFT JOIN
            arrangers ar ON s.song_id = ar.song_id
        WHERE
            s.song_id = #{id}
        GROUP BY s.title, a.album_name, a.album_image, s.genre, si.singer_name, s.lyrics
    </select>
  
    <select id="isLikes" resultType="integer">
        select count(*) from likes where song_id = #{songId} and id = #{id}
    </select>
    
    <insert id="addLike">
        insert into likes (song_id, id) values (#{songId}, #{id})
    </insert>
    
    <delete id="removeLike">
        delete from likes where song_id = #{songId} and id = #{id}
    </delete>
    
    
  </mapper>